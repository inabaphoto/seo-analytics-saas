---
trigger: always_on
description: "Google OAuth2 PKCE フロー実装に関するルール"
---

# Google OAuth2 PKCE フロー実装ガイド

## 1. 基本方針

- すべての OAuth2 通信は PKCE (Proof Key for Code Exchange) フローを使用する
- 認証トークンは安全に保存し、暗号化する
- リフレッシュトークンは必ず使用する
- トークンの有効期限を常にチェックする

## 2. 実装要件

### 2.1 フロントエンド

- `code_verifier` と `code_challenge` の生成には `crypto-js` または同等のライブラリを使用
- 認証フロー中は状態管理を確実に行う
- エラーハンドリングを適切に実装

### 2.2 バックエンド

- 認可コードからアクセストークンへの交換は必ずサーバーサイドで行う
- トークンの検証を厳密に行う
- セキュアなCookieを使用する

## 3. セキュリティ対策

- `state` パラメータを使用してCSRF攻撃を防ぐ
- `nonce` パラメータを使用してリプレイ攻撃を防ぐ
- HTTPS を必須とする
- トークンの有効期限を短く設定

## 4. エラーハンドリング

- 認証エラーはユーザーフレンドリーなメッセージで表示
- ログには詳細なエラー情報を記録
- リトライメカニズムを実装
